---
title: "EDA_USING_R_LOAN_DATA"
author: "Deepak Singh"
date: "February 22, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE)
```

## Reading the dataset and producing summary of Loan amount

We will start with reading the loan proser data into the variable and produce summaries of some variables. Below is the summary of The origination amount of the loan.

```{r Loan Prosper Data, echo=FALSE}
lp<-read.csv("C:/Users/singhd5/Documents/Self docs/Udacity/udacity-git-course/EDA-USING-R/EXPLORE_AND_SUMMARIZE_DATA_WITH_R/prosperLoanData.csv",sep = ",")
attach(lp)
summary(LoanOriginalAmount)
```

## Producing histogram of Loan amount

The histogram of the loan amount reveals that there are few ouliers i the dataset. Also, the distribution of LoanOriginalAmount seems to skewed with few spikes.

```{r histogram plot loan amount, echo=FALSE}
library(ggplot2)
library(gridExtra)
ggplot(aes(LoanOriginalAmount), data = lp)+
  geom_histogram(binwidth = 1000)
  #xlim(0,quantile(LoanOriginalAmount,0.99))
  
```

```{r transformed histogram plot, echo=FALSE}
ggplot(aes(LoanOriginalAmount), data = lp)+
  geom_histogram(bins = 50)+
    scale_x_log10()

```

Transformed the skewed distributed data for loan amount to better understand the the distribution of loan amount. The transformed distribution looks more like normaly distributed. Lets see if the employment status has an effect on the loan amount.

```{r histogram with employment status, echo=FALSE}
ggplot(aes(y = LoanOriginalAmount, x = EmploymentStatus), data = lp)+
  geom_boxplot()
    

by(LoanOriginalAmount,EmploymentStatus,summary)
table(EmploymentStatus)
```

We can see from above that mean of loan amount is highest from the Employed followed by full-time then self-employed. Same is true for the number of loans issued for the respective employmentstatus

## Analysing the bad loans

In this ananlysis we are going to see if there is any relationship of bad loans(loan status of chargedoff, defaulted) with credit score

```{r Analysing the bad loans, echo=FALSE}
lp$LoanOriginationDate <- as.Date(lp$LoanOriginationDate)
lp.badloans <- subset(lp, (LoanStatus == 'Defaulted' | LoanStatus == 'Chargedoff') & LoanOriginationDate > ("2009-07-31"))

by(lp.badloans$ProsperScore,lp.badloans$LoanStatus,summary)

ggplot(aes(y = lp.badloans$LoanOriginalAmount, x = lp.badloans$LoanStatus), data = lp.badloans)+
  geom_boxplot()

```

There are 6348 bad loans in the dataset after July 2009 and out of those the mean ProsperScore  were 5.39 and 5.62 for both ChargedOff or Defaulted Loan status respectively

## Analysis of Income ranges

```{r}
lp$IncomeRange <- factor(lp$IncomeRange,levels = c("Not employed", "$0", "Not displayed",
                "$1-24,999", "$25,000-49,999", "$50,000-74,999",
                "$75,000-99,999", "$100,000+"))
#print(levels(IncomeRange))

ggplot(aes(IncomeRange), data = lp)+
  geom_bar(stat = 'count')

```


Income ranges are not normally distributed with peak for income ranging 25,000-49,999.

## Analysis of Loans by state

```{r}
lp$BadLoan <- ifelse(LoanStatus == "Defaulted" | LoanStatus == "Chargedoff"| LoanStatus == "Past Due (61-90 days)" |LoanStatus == "Past Due (91-120 days)" |LoanStatus == "Past Due (>120 days)" ,"Yes","No")
ggplot(aes(BorrowerState, fill = lp$BadLoan), data = lp)+
  geom_histogram(stat = 'count')

```
Largest number of borrowers are from California.

## Analysis of Loans by Listing Category

```{r}

ggplot(aes(ListingCategory..numeric., fill = lp$BadLoan), data = lp)+
  geom_histogram(stat = 'count')

```

## Analysis of StatedMonthlyIncome

```{r}
ggplot(aes(lp$StatedMonthlyIncome), data = lp)+
  geom_histogram(bins = 500)+
  xlim(0,20000)
```

The distribution appears to be skewed


## Analysis of MonthlyLoanPayment

```{r}
ggplot(aes(lp$MonthlyLoanPayment), data = lp)+
  geom_histogram(bins = 50)

```

Monthly Loan payment appears to be positively skewed

## Analysis of Loan term on loans

```{r}


ggplot(aes(lp$LoanOriginalAmount, fill = as.factor(lp$Term)), data = lp)+
  geom_histogram(bins = 50)

```
Most of the loan amount are termed at 36 months.


# Univariate Analysis
##What is the structure of your dataset?

There are 113,937 observations in the dataset with 81 variables. 

Some of the Continuous Variables are:

EmploymentStatusDuration CreditScoreRangeLower CreditScoreRangeUpper CurrentCreditLines DebtToIncomeRatio StatedMonthlyIncome BorrowerAPR BorrowerRate LoanOriginalAmount MonthlyLoanPayment

Some of the Discrete Variables are:

BorrowerState Occupation EmploymentStatus IsBorrowerHomeowner IncomeRange IncomeVerifiable Term ListingCategory LoanStatus LoanOriginationDate


##What is/are the main feature(s) of interest in your dataset?

There are a number of features that will give insights to the profile of the loan and borrower. I think the main ones for borrowers are credit score, income and the ones for the loans are loan amount, interest rate, and term.

##What other features in the dataset do you think will help support your investigation into your feature(s) of interest?

Loan category and status can help determine how the loans are being used and what loans are current, defaulted, delinquent etc (Bad Loans). Also, we can leverage Employment status and explore the impact on Loan.

##Did you create any new variables from existing variables in the dataset?

I created a new categorical variables that determines a loan is a Bad Loan or not. I grouped the loans with status of
 "Defaulted" , "Chargedoff", "Past Due (61-90 days)" , "Past Due (91-120 days)" and "Past Due (>120 days)" as Bad loans

##Analysis of Loan Amount with Listing Category

```{r}
str(ListingCategory..numeric.)

ggplot(aes(x = as.factor(ListingCategory..numeric.), y = LoanOriginalAmount), data = lp)+
  geom_boxplot()
   
```


From the above plot we can see that Debt consolidation(1) as expected has the highest loan amounts across categories; however, unexpectedly "Baby and Adoption" (8) category is also the highest (tied) loan amount across categories

##Analysis of Borrower rate with Credit score 

```{r}
ggplot(aes(x = CreditScoreRangeLower , y = BorrowerRate), data = lp)+
  geom_point(alpha = 1/50, position = 'jitter')

cor.test(CreditScoreRangeLower, BorrowerRate)
```


The above plot seems to have negative correlation and it follows the general understanding of - interest rate is lower for more creditworthy borrowers

## Analysis of Debt-to-Income ratio with Monthly Income

```{r}
ggplot(aes(x = StatedMonthlyIncome , y = DebtToIncomeRatio, color = BadLoan), data = lp)+
  geom_point( alpha = 1/5 , position = 'jitter')+
  xlim(0,20000)+
  ylim(0,2)

```


In comparing debt-to-income ratio with a borrower's stated monthly income I was expecting to see a trend that delinquent borrowers would have a lower monthly income and a higher debt-to-income ratio.

## Analysis of Borrower rate with Loan amount

```{r}
ggplot(aes(x = LoanOriginalAmount , y = BorrowerRate), data = lp)+
  geom_point( alpha = 1/10,position = 'jitter')

```


There appears to be a negative correlation. There are some large loan amounts with low Borrower rate.

## Analysis of Loan term with Borrower rate

```{r}
ggplot(aes(x = as.factor(Term) , y = BorrowerRate), data = lp)+
  geom_boxplot()
```

I was expecting to see low rate as the term increases but as shown from the above plot small terms have the lowest mean borrower rate. There are other factors in addition to the loan term affecting the borrower rate.



#Bivariate Analysis
##Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?

There's a negative relationship between interest rates and loan amount, the larger the loan, the lower the rate on average. That was mostly due to them having higher credit scores.

Delinquent borrowers would have a lower monthly income and a higher debt-to-income ratio

There is a negative correlation between Credit score and Borrower rate - interest rate is lower for more creditworthy borrowers

##Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

Debt consolidation as expected has the highest loan amounts across categories; however, unexpectedly "Baby and Adoption" category is also the highest (tied) loan amount across categories.

##What was the strongest relationship you found?

The strongest relationship I found was between credit score and interest rate, with -0.46. This makes sense since credit score is a rating of the credit-worthiness of the borrower and that should be related to the cost of borrowing (interest rate).


##Correlation Matrix

```{r}
library("GGally")
lp.subset <- lp [,c("BadLoan","StatedMonthlyIncome","DebtToIncomeRatio","BorrowerRate","LoanStatus","LoanOriginalAmount","CreditScoreRangeLower","ListingCategory..numeric.","EmploymentStatus","MonthlyLoanPayment", "BorrowerAPR", "CreditScoreRangeUpper")]
ggcorr(lp.subset, label = TRUE, label_size = 3, color = "black", layout.exp = 2)

```

The correlation matrix revealed a few surprising things - I thought there would be a much stronger relationship between interest rate (BorrowerRate) and the credit score (CreditScoreRangeUpper/Lower). At a score of -0.5 it's the strongest correlation out of the selected variables.

## Analysis of credit score with loan amount and BadLoans

```{r}
ggplot(aes(x = CreditScoreRangeUpper, y = LoanOriginalAmount), data = lp)+
  geom_point(alpha = 1/50, position = 'jitter')+
  facet_wrap(~BadLoan)
```


In the above comparisons, both scatterplots show a borrower's credit score against their loan amounts.The higher concentration of Bad Loans have lower credit scores, and they also tend to borrow less money, under $10,000.
Also, we can see that lower loan amount for borrowers with much higher credit scores. Based on previous analysis, higher scores provide lower rates, which would tend to allow the borrower to gain access to a higher loan amount. And although the average loan amount for loans in good standing are higher, there is still a high concentration of loans under $20,000 and with credit scores over 700.

##Analysis of Loan Amount with Borrower rate and Credit score

```{r}

ggplot(aes(x = LoanOriginalAmount , y = BorrowerRate , color = CreditScoreRangeLower), data = subset(lp,lp$CreditScoreRangeLower > 650))+
  geom_point(position = 'jitter')

```

The borrowers with high credit scores have lower interest rates and larger loan amounts. I subsetted only credit scores from 660 (1st quartile) and above for better visual presentation.



